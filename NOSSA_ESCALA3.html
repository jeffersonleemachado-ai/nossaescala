<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossa Escala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            background-image: url('https://raw.githubusercontent.com/google/gemini-web-chat/main/Árvores_no_SESC_Mogi_das_Cruzes_2022_07_06.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e2e8f0;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: rgba(30, 30, 30, 0.85);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            border: 1px solid #2d3748;
        }
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #2d3748;
        }
        th {
            background-color: #2d3748;
            font-weight: 600;
            color: #e2e8f0;
        }
        .lunch-cell {
            background-color: #4a192c;
            color: #fca5a5;
        }
        .opening-cell {
            background-color: #1f3d2f;
            font-weight: 600;
            color: #99f6e4;
        }
        input[type="text"], input[type="email"], input[type="password"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
        }
        .btn-primary {
            background-color: #10b981;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-primary:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #4a5568;
            color: #e2e8f0;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-secondary:hover {
            background-color: #2d3748;
            transform: translateY(-2px);
        }
        .export-layout {
            background-color: #1e1e1e;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .export-layout h3 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #e2e8f0;
            text-align: center;
            margin-bottom: 2rem;
        }
        .export-layout table {
            border: 2px solid #2d3748;
        }
        .export-layout th, .export-layout td {
            border: 1px solid #2d3748;
            padding: 1.25rem;
        }
        .hidden {
            display: none;
        }
        #login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }
        #main-app {
            display: none;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message-box {
            background-color: #1e1e1e;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
            color: #e2e8f0;
        }
        .message-box p {
            font-size: 1rem;
            color: #e2e8f0;
            margin-bottom: 1rem;
        }
        .message-box button {
            background-color: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-8">

    <!-- Seção de Login -->
    <div id="login-section" class="space-y-8">
        <div class="card space-y-6">
            <h1 class="text-4xl font-bold text-white">Nossa Escala</h1>
            <p class="mt-2 text-lg text-gray-400">Equipe de comunicação - Sesc Mogi das Cruzes</p>
            <div id="auth-ui" class="mt-8 space-y-4">
                <input type="email" id="email-input" placeholder="E-mail (nome de usuário)" class="w-full p-2 border rounded">
                <input type="password" id="password-input" placeholder="Senha" class="w-full p-2 border rounded">
                <button id="login-btn" class="btn-primary w-full">Entrar</button>
                <button id="signup-btn" class="btn-secondary w-full">Cadastrar</button>
            </div>
            <div id="loading-spinner" class="loading-spinner hidden mx-auto"></div>
            <p id="user-info" class="text-gray-400 mt-4 hidden">Bem-vindo, <span id="user-name"></span>!</p>
        </div>
    </div>

    <!-- Seção Principal do App -->
    <div id="main-app" class="container mx-auto space-y-12">
        <header class="text-center">
            <h1 class="text-5xl font-extrabold text-white">Nossa Escala</h1>
            <p class="mt-4 text-xl text-gray-400">Equipe de comunicação - Sesc Mogi das Cruzes</p>
            <button id="logout-btn" class="btn-secondary mt-6">Sair</button>
        </header>

        <!-- Seção para Adicionar Pessoas e Postos -->
        <div class="card space-y-6">
            <h2 class="text-3xl font-bold text-white">Configurações</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-3">Adicionar Novo Membro</h3>
                    <div class="flex space-x-2">
                        <input type="text" id="newMemberName" placeholder="Nome do membro" class="flex-grow">
                        <button id="addMemberBtn" class="btn-primary">Adicionar</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">Adicionar Novo Posto</h3>
                    <div class="flex space-x-2">
                        <input type="text" id="newPostName" placeholder="Nome do posto" class="flex-grow">
                        <button id="addPostBtn" class="btn-primary">Adicionar</button>
                    </div>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-3">Membros da Equipe</h3>
                    <ul id="membersList" class="list-disc list-inside space-y-2"></ul>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">Postos de Trabalho</h3>
                    <ul id="postsList" class="list-disc list-inside space-y-2"></ul>
                </div>
            </div>
        </div>

        <!-- Nova Seção para o Funcionário de Abertura -->
        <div class="card space-y-6">
            <h2 class="text-3xl font-bold text-white">Funcionário de Abertura</h2>
            <div>
                <label for="openingMemberSelect" class="block text-sm font-medium text-gray-400">Selecione o membro que fará a abertura:</label>
                <select id="openingMemberSelect" class="w-full mt-2"></select>
            </div>
        </div>
        
        <!-- Nova Seção para Atribuir Horário de Almoço -->
        <div class="card space-y-6">
            <h2 class="text-3xl font-bold text-white">Atribuir Almoço</h2>
            <div id="lunchAssignmentFields" class="grid md:grid-cols-2 gap-4">
                <p class="text-gray-400 col-span-2 text-center">Por favor, selecione uma data para atribuir os horários de almoço.</p>
            </div>
        </div>

        <!-- Seção para Criar a Escala -->
        <div class="card space-y-6">
            <h2 class="text-3xl font-bold text-white">Criar Escala</h2>
            <div>
                <label for="scheduleDate" class="block text-sm font-medium text-gray-400">Data:</label>
                <input type="date" id="scheduleDate" class="mt-2 block w-full">
            </div>
            
            <!-- Opções de Escala de Evento Geral -->
            <div class="flex items-center space-x-4 mt-4">
                <input type="checkbox" id="isEventDay" class="form-checkbox h-5 w-5 text-green-600 rounded">
                <label for="isEventDay" class="text-sm font-medium text-gray-400">Ativar Escala de Evento</label>
            </div>
            
            <div class="flex items-center space-x-6 mt-4">
                <div class="flex items-center space-x-2">
                    <input type="radio" id="dailyMode" name="schedulePeriod" value="daily" checked>
                    <label for="dailyMode">Diária</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="radio" id="weeklyMode" name="schedulePeriod" value="weekly">
                    <label for="weeklyMode">Semanal</label>
                </div>
            </div>
            <div class="flex items-center space-x-6 mt-4">
                <label class="text-sm font-medium text-gray-400">Modo de Geração:</label>
                <div class="flex space-x-2">
                    <input type="radio" id="manualMode" name="scheduleMode" value="manual" checked>
                    <label for="manualMode">Manual</label>
                    <input type="radio" id="autoMode" name="scheduleMode" value="auto">
                    <label for="autoMode">Automático</label>
                </div>
            </div>
            
            <div id="generation-info" class="p-4 bg-yellow-900 rounded-lg text-sm text-yellow-300 border border-yellow-700 mt-2">
                <p>🔔 **Atenção**</p>
                <p>A geração automática da escala só funciona corretamente quando o número de postos de trabalho é igual ao número de funcionários disponíveis.</p>
                <p>⚠️ **Importante:** ALMOÇO não é considerado um posto de trabalho, portanto não deve ser incluído nessa contagem.</p>
            </div>
            
            <!-- Configurações para Evento Geral -->
            <div id="eventConfig" class="grid md:grid-cols-2 gap-8 hidden">
                <div class="md:col-span-2">
                    <div class="flex items-center space-x-4">
                        <input type="checkbox" id="isOvertimeNeeded" class="form-checkbox h-5 w-5 text-purple-600 rounded">
                        <label for="isOvertimeNeeded" class="text-sm font-medium text-gray-400">Haverá Hora Extra?</label>
                    </div>
                </div>
                 <div class="md:col-span-2 space-y-4">
                     <div>
                        <label for="eventName" class="block text-sm font-medium text-gray-400">Nome do Evento:</label>
                        <input type="text" id="eventName" placeholder="Nome do Evento" class="mt-2 block w-full">
                     </div>
                     <div>
                        <h3 class="text-xl font-semibold mb-3">Horário do Evento</h3>
                        <select id="eventTimeSelect" class="w-full">
                           <option value="18">18h</option>
                           <option value="19">19h</option>
                           <option value="20">20h</option>
                        </select>
                     </div>
                </div>
                <div class="md:col-cols-2">
                    <h3 class="text-xl font-semibold mb-3">Horário do Grupo 2</h3>
                    <select id="group2ScheduleType" class="w-full">
                        <option value="11h-20h">Entrada 11h / Saída 20h</option>
                        <option value="12h-21h">Entrada 12h / Saída 21h</option>
                    </select>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">Pessoas do Grupo 1 (Horário Normal)</h3>
                    <select id="group1Select" multiple class="w-full h-48 border border-gray-600 rounded-md"></select>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">Pessoas do Grupo 2 (Horário Estendido)</h3>
                    <select id="group2Select" multiple class="w-full h-48 border border-gray-600 rounded-md"></select>
                </div>
            </div>
            
            <!-- Configurações para Show de Quinta -->
            <div id="thursdayShowConfig" class="space-y-4 hidden">
                <h3 class="text-xl font-semibold mb-3">Show de Quinta-Feira</h3>
                <div>
                    <label for="showNameInput" class="block text-sm font-medium text-gray-400">Nome do Show:</label>
                    <input type="text" id="showNameInput" placeholder="Ex: Show de Jazz" class="mt-2 block w-full">
                </div>
                <div>
                    <label for="showMemberSelect" class="block text-sm font-medium text-gray-400">Funcionário para o show:</label>
                    <select id="showMemberSelect" class="w-full mt-2"></select>
                </div>
            </div>
            
            <div id="scheduleTableContainer" class="table-container mt-6"></div>
            <div class="flex flex-wrap gap-4 mt-6">
                <button id="generateScheduleBtn" class="btn-secondary">Gerar Escala</button>
                <button id="saveCloudBtn" class="btn-primary hidden">Salvar na Nuvem</button>
                <button id="exportScheduleBtn" class="btn-primary hidden">Exportar como JPG</button>
                <button id="exportExcelBtn" class="btn-primary hidden">Exportar como Excel</button>
            </div>
        </div>

        <!-- Seção de Escalas Salvas na Nuvem -->
        <div class="card space-y-6">
            <h2 class="text-3xl font-bold text-white">Escalas Salvas na Nuvem</h2>
            <div class="flex space-x-4">
                <input type="text" id="filterCreatorInput" placeholder="Filtrar por nome do criador..." class="flex-grow">
                <button id="filterCreatorBtn" class="btn-secondary">Filtrar</button>
            </div>
            <div id="cloudSchedulesList" class="space-y-3">
                <p id="loading-cloud" class="text-gray-500">Carregando escalas...</p>
            </div>
        </div>
        
        <!-- Nova seção para exportação seletiva -->
        <div id="selectiveExport" class="card space-y-6 hidden">
             <h2 class="text-3xl font-bold text-white">Exportar Dias Específicos</h2>
             <div id="exportDayButtons" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Dashboard de Histórico de Postos (Novidade) -->
        <div class="card space-y-6">
            <h2 class="text-3xl font-bold text-white">Análise de Distribuição de Postos</h2>
            <div id="chartContainer" class="bg-gray-800 p-6 rounded-lg">
                <p class="text-gray-400 mb-4">Mantenha a rotação de postos justa. Este gráfico mostra quantas vezes cada funcionário foi escalado para cada posto nas últimas 4 semanas.</p>
                <canvas id="postDistributionChart"></canvas>
            </div>
            <button id="exportAnalysisBtn" class="btn-secondary w-full">Exportar Análise (JPG)</button>
        </div>

    </div>

    <!-- Modal de Confirmação e Mensagens -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4">
        <div class="message-box">
            <p id="modalMessage" class="text-center font-medium mb-4"></p>
            <div class="flex justify-center space-x-4" id="modalButtons">
                <button id="modalConfirmBtn" class="btn-primary">Sim</button>
                <button id="modalCancelBtn" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Layout Oculto para Exportação da Imagem -->
    <div id="exportLayout" class="export-layout" style="position: absolute; left: -9999px; top: -9999px;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc, getDocs as getDocsFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginSection = document.getElementById('login-section');
        const mainApp = document.getElementById('main-app');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userNameSpan = document.getElementById('user-name');
        const loadingSpinner = document.getElementById('loading-spinner');
        const cloudSchedulesList = document.getElementById('cloudSchedulesList');
        const loadingCloud = document.getElementById('loading-cloud');
        const filterCreatorInput = document.getElementById('filterCreatorInput');
        const filterCreatorBtn = document.getElementById('filterCreatorBtn');
        const newMemberNameInput = document.getElementById('newMemberName');
        const addMemberBtn = document.getElementById('addMemberBtn');
        const membersList = document.getElementById('membersList');
        const newPostNameInput = document.getElementById('newPostName');
        const addPostBtn = document.getElementById('addPostBtn');
        const postsList = document.getElementById('postsList');
        const scheduleDateInput = document.getElementById('scheduleDate');
        const isEventDayCheckbox = document.getElementById('isEventDay');
        const eventConfigDiv = document.getElementById('eventConfig');
        const group1Select = document.getElementById('group1Select');
        const group2Select = document.getElementById('group2Select');
        const isOvertimeNeededCheckbox = document.getElementById('isOvertimeNeeded');
        const group2ScheduleTypeSelect = document.getElementById('group2ScheduleType');
        const generateScheduleBtn = document.getElementById('generateScheduleBtn');
        const saveCloudBtn = document.getElementById('saveCloudBtn');
        const exportScheduleBtn = document.getElementById('exportScheduleBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const scheduleTableContainer = document.getElementById('scheduleTableContainer');
        const exportLayoutDiv = document.getElementById('exportLayout');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalButtons = document.getElementById('modalButtons');
        const openingMemberSelect = document.getElementById('openingMemberSelect');
        const dailyModeRadio = document.getElementById('dailyMode');
        const weeklyModeRadio = document.getElementById('weeklyMode');
        const schedulePeriodRadios = document.getElementsByName('schedulePeriod');
        const manualModeRadio = document.getElementById('manualMode');
        const autoModeRadio = document.getElementById('autoMode');
        const selectiveExportDiv = document.getElementById('selectiveExport');
        const exportDayButtonsDiv = document.getElementById('exportDayButtons');
        const eventNameInput = document.getElementById('eventName');
        const eventTimeSelect = document.getElementById('eventTimeSelect');
        const thursdayShowConfigDiv = document.getElementById('thursdayShowConfig');
        const showNameInput = document.getElementById('showNameInput');
        const showMemberSelect = document.getElementById('showMemberSelect');
        const lunchAssignmentFields = document.getElementById('lunchAssignmentFields');
        const postDistributionChartCanvas = document.getElementById('postDistributionChart');
        const exportAnalysisBtn = document.getElementById('exportAnalysisBtn');
        const chartContainer = document.getElementById('chartContainer');

        let userId = null;
        let members = ['Lee', 'Carol', 'Mari', 'Ju', 'Karen', 'Robert'];
        let posts = ['P1', 'CATRACA', 'VESTIÁRIO', 'SOÇAITE', 'TENDA', 'PDV', 'ALMOÇO', 'CIRCULAÇÃO'];
        let currentSchedule = [];
        let lastPostAssignment = {};
        let allCloudSchedules = [];
        let creatorName = '';
        let openingMember = null;
        let isWeeklyMode = false;
        let postHistory = {};
        let chartInstance = null;

        async function showApp() {
            loginSection.style.display = 'none';
            mainApp.style.display = 'block';
            addMemberBtn.disabled = false;
            await loadPostHistory();
        }

        async function showLogin() {
            loginSection.style.display = 'flex';
            mainApp.style.display = 'none';
            addMemberBtn.disabled = true;
        }

        function showModal(message, callback, isConfirm = true) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            if (isConfirm) {
                modalButtons.style.display = 'flex';
                modalConfirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    callback(true);
                };
                modalCancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    callback(false);
                };
            } else {
                modalButtons.style.display = 'none';
                setTimeout(() => {
                    modal.classList.add('hidden');
                    callback();
                }, 2000);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                creatorName = user.email ? user.email.split('@')[0] : 'Usuário';
                userNameSpan.textContent = creatorName;
                userInfo.classList.remove('hidden');
                showApp();
                await loadUserData();
                listenToCloudSchedules();
            } else {
                userId = null;
                showLogin();
            }
            loadingSpinner.classList.add('hidden');
        });

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(e => {
                console.error("Erro ao autenticar com token personalizado:", e);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loadingSpinner.classList.remove('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showModal("Erro ao fazer login: " + error.message, () => {}, false);
                loadingSpinner.classList.add('hidden');
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loadingSpinner.classList.remove('hidden');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showModal("Conta criada com sucesso! Você já está logado.", () => {}, false);
            } catch (error) {
                showModal("Erro ao criar conta: " + error.message, () => {}, false);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });
        
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showModal("Desconectado com sucesso.", () => {}, false);
        });

        async function loadUserData() {
            if (!userId) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.members) members = data.members;
                    if (data.posts) posts = data.posts;
                    renderMembers();
                    renderPosts();
                } else {
                    console.log("Nenhum dado de usuário encontrado, usando valores padrão.");
                }
            } catch (e) {
                console.error("Erro ao carregar dados do usuário: ", e);
            }
        }

        async function saveUserData() {
            if (!userId) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            try {
                await setDoc(userDocRef, { members, posts }, { merge: true });
                console.log("Dados de usuário salvos com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar dados do usuário: ", e);
            }
        }
        
        async function loadPostHistory() {
            if (!userId) return;
            const schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
            const now = new Date();
            const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30));
            
            const querySnapshot = await getDocsFirestore(schedulesCollectionRef);
            
            let tempHistory = {};
            members.forEach(member => {
                tempHistory[member] = {};
                posts.forEach(post => {
                    tempHistory[member][post] = 0;
                });
            });

            querySnapshot.forEach(doc => {
                const data = doc.data();
                const scheduleDate = new Date(data.date);
                if (scheduleDate > thirtyDaysAgo) {
                    const schedules = JSON.parse(data.schedule);
                    schedules.forEach(daySchedule => {
                         daySchedule.schedule.forEach(hourEntry => {
                            for (const member in hourEntry.assignments) {
                                const post = hourEntry.assignments[member];
                                if (tempHistory[member] && tempHistory[member][post] !== undefined) {
                                    tempHistory[member][post]++;
                                }
                            }
                         });
                    });
                }
            });
            
            postHistory = tempHistory;
            renderPostDistributionChart();
        }

        function renderPostDistributionChart() {
            const chartData = {
                labels: members,
                datasets: []
            };

            const postColors = {
                'P1': '#FF6384', 'CATRACA': '#36A2EB', 'VESTIÁRIO': '#FFCE56', 'SOÇAITE': '#4BC0C0', 
                'TENDA': '#9966FF', 'PDV': '#FF9F40', 'CIRCULAÇÃO': '#FF5733', 'SHOW DE QUINTA': '#76D7C4',
                'BIPAGEM': '#FFC0CB', 'PCD': '#DA70D6', 'GEODÉSICA': '#8A2BE2'
            };

            posts.filter(p => p !== 'ALMOÇO').forEach(post => {
                const data = members.map(member => postHistory[member]?.[post] || 0);
                chartData.datasets.push({
                    label: post,
                    data: data,
                    backgroundColor: postColors[post] || '#C9CBCE',
                });
            });

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(postDistributionChartCanvas, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true, grid: { color: '#4a5568' } },
                        y: { stacked: true, beginAtZero: true, grid: { color: '#4a5568' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } }
                    }
                }
            });
        }

        async function saveScheduleToCloud(creator) {
            if (!userId || currentSchedule.length === 0 || !scheduleDateInput.value) {
                showModal("Por favor, gere uma escala e faça o login para salvar.", () => {}, false);
                return;
            }
            syncScheduleFromDOM();
            const scheduleDate = scheduleDateInput.value;
            
            const docId = isWeeklyMode ? `${scheduleDate}_weekly` : scheduleDate;
            const scheduleDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', docId);

            try {
                await setDoc(scheduleDocRef, {
                    date: scheduleDate,
                    schedule: JSON.stringify(currentSchedule),
                    members: members,
                    posts: posts,
                    userId: userId,
                    creator: creator,
                    isWeekly: isWeeklyMode,
                    eventName: eventNameInput.value,
                    eventTime: eventTimeSelect.value
                });
                showModal("Escala salva na nuvem com sucesso!", () => {}, false);
                loadPostHistory();
            } catch (e) {
                console.error("Erro ao salvar a escala na nuvem: ", e);
                showModal("Ocorreu um erro ao salvar a escala na nuvem.", () => {}, false);
            }
        }

        function listenToCloudSchedules() {
            if (!userId) return;
            const schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
            onSnapshot(schedulesCollectionRef, (snapshot) => {
                allCloudSchedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCloudSchedules();
            });
        }
        
        function renderCloudSchedules(filteredSchedules = allCloudSchedules) {
            loadingCloud.classList.add('hidden');
            cloudSchedulesList.innerHTML = '';
            if (filteredSchedules.length === 0) {
                cloudSchedulesList.innerHTML = '<p class="text-gray-500">Nenhuma escala salva na nuvem ainda.</p>';
            } else {
                filteredSchedules.forEach(data => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg border border-gray-600 text-gray-200';
                    const displayDate = data.isWeekly ? `Semana de ${new Date(data.date).toLocaleDateString('pt-BR')}` : new Date(data.date).toLocaleDateString('pt-BR');
                    item.innerHTML = `
                        <span class="font-medium text-gray-200">${displayDate} (Criado por: ${data.creator})</span>
                        <div class="space-x-2">
                            <button class="load-cloud-btn btn-primary text-sm p-1 px-3">Carregar</button>
                            <button class="delete-cloud-btn text-red-400 hover:text-red-300 text-sm p-1 px-3">Excluir</button>
                        </div>
                    `;
                    item.querySelector('.load-cloud-btn').dataset.id = data.id;
                    item.querySelector('.delete-cloud-btn').dataset.id = data.id;
                    cloudSchedulesList.appendChild(item);
                });
            }
        }
        
        filterCreatorBtn.addEventListener('click', () => {
            const filterName = filterCreatorInput.value.trim().toLowerCase();
            const filtered = allCloudSchedules.filter(schedule => 
                schedule.creator && schedule.creator.toLowerCase().includes(filterName)
            );
            renderCloudSchedules(filtered);
        });

        cloudSchedulesList.addEventListener('click', async (e) => {
            const target = e.target;
            const scheduleId = target.dataset.id;
            if (target.classList.contains('load-cloud-btn')) {
                const scheduleDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);
                const docSnap = await getDoc(scheduleDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    members = data.members;
                    posts = data.posts;
                    isWeeklyMode = data.isWeekly;
                    currentSchedule = JSON.parse(data.schedule);
                    scheduleDateInput.value = data.date;
                    isEventDayCheckbox.checked = posts.includes('BIPAGEM');
                    eventConfigDiv.classList.toggle('hidden', !isEventDayCheckbox.checked);
                    renderMembers();
                    renderPosts();
                    renderSchedule(currentSchedule, scheduleDateInput.value);
                    if (isWeeklyMode) {
                        weeklyModeRadio.checked = true;
                    } else {
                        dailyModeRadio.checked = true;
                    }
                    saveCloudBtn.classList.remove('hidden');
                    exportScheduleBtn.classList.remove('hidden');
                    exportExcelBtn.classList.remove('hidden');
                    showModal("Escala carregada da nuvem com sucesso!", () => {}, false);
                } else {
                    showModal("Escala não encontrada na nuvem.", () => {}, false);
                }
            } else if (target.classList.contains('delete-cloud-btn')) {
                showModal("Tem certeza que deseja excluir esta escala? Esta ação é irreversível.", async (confirmed) => {
                    if (confirmed) {
                        try {
                            const scheduleDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);
                            await deleteDoc(scheduleDocRef);
                            showModal("Escala excluída com sucesso.", () => {}, false);
                        } catch (e) {
                            console.error("Erro ao excluir a escala: ", e);
                            showModal("Ocorreu um erro ao excluir a escala.", () => {}, false);
                        }
                    }
                });
            }
        });
        
        function getLunchHoursForDate(date) {
            const dayOfWeek = new Date(date + 'T00:00:00').getDay();
            if (dayOfWeek === 6 || dayOfWeek === 0) {
                return [12, 13, 14, 15];
            }
            return [16, 17, 18, 19];
        }

        function renderLunchAssignmentFields() {
            lunchAssignmentFields.innerHTML = '';
            const selectedDate = scheduleDateInput.value;
            if (!selectedDate) {
                 lunchAssignmentFields.innerHTML = '<p class="text-gray-400 col-span-2 text-center">Por favor, selecione uma data para atribuir os horários de almoço.</p>';
                 return;
            }
            
            const isEventDay = isEventDayCheckbox.checked;
            const group1Members = isEventDay ? Array.from(group1Select.selectedOptions).map(opt => opt.value) : [];
            const group2Members = isEventDay ? Array.from(group2Select.selectedOptions).map(opt => opt.value) : [];

            members.forEach(member => {
                const field = document.createElement('div');
                field.className = 'flex flex-col space-y-1';
                const label = document.createElement('label');
                label.className = 'text-sm font-medium text-gray-400';
                label.textContent = member;
                const select = document.createElement('select');
                select.id = `lunch-${member.replace(/\s/g, '-')}`;
                select.className = 'w-full rounded-md bg-gray-700 text-gray-200';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Automático';
                select.appendChild(defaultOption);

                let lunchHours = [];
                if (isEventDay) {
                    if (group1Members.includes(member)) {
                        lunchHours = [12, 13, 14, 15];
                    } else if (group2Members.includes(member)) {
                        lunchHours = [15, 16];
                    }
                } else {
                    lunchHours = getLunchHoursForDate(selectedDate);
                }

                lunchHours.forEach(hour => {
                    const option = document.createElement('option');
                    option.value = hour;
                    option.textContent = `${hour}h`;
                    select.appendChild(option);
                });

                field.appendChild(label);
                field.appendChild(select);
                lunchAssignmentFields.appendChild(field);
            });
        }

        function renderMembers() {
            membersList.innerHTML = '';
            group1Select.innerHTML = '';
            group2Select.innerHTML = '';
            openingMemberSelect.innerHTML = '';
            showMemberSelect.innerHTML = '';
            members.forEach(member => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-md';
                li.textContent = member;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remover';
                removeBtn.className = 'text-red-400 hover:text-red-300 text-sm';
                removeBtn.onclick = () => removeMember(member);
                li.appendChild(removeBtn);
                membersList.appendChild(li);

                const option1 = document.createElement('option');
                option1.value = member;
                option1.textContent = member;
                group1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = member;
                option2.textContent = member;
                group2Select.appendChild(option2);

                const openingOption = document.createElement('option');
                openingOption.value = member;
                openingOption.textContent = member;
                openingMemberSelect.appendChild(openingOption);

                const showOption = document.createElement('option');
                showOption.value = member;
                showOption.textContent = member;
                showMemberSelect.appendChild(showOption);
            });
            saveUserData();
            renderLunchAssignmentFields();
        }

        function addMember() {
            if (!userId) {
                showModal("Você precisa estar logado para adicionar membros.", () => {}, false);
                return;
            }
            const name = newMemberNameInput.value.trim();
            if (name && !members.includes(name)) {
                members.push(name);
                newMemberNameInput.value = '';
                renderMembers();
            }
        }

        function removeMember(memberToRemove) {
            showModal(`Tem certeza que deseja remover ${memberToRemove}?`, (confirmed) => {
                if (confirmed) {
                    members = members.filter(member => member !== memberToRemove);
                    renderMembers();
                }
            });
        }

        addMemberBtn.addEventListener('click', addMember);
        newMemberNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addMember();
        });

        function renderPosts() {
            postsList.innerHTML = '';
            posts.forEach((post) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-md';
                li.innerHTML = `
                    <span>${post}</span>
                    ${!['ALMOÇO', 'P1', 'VESTIÁRIO', 'SHOW DE QUINTA'].includes(post) ? `<button class="text-red-400 hover:text-red-300 text-sm" data-post="${post}">Remover</button>` : ''}
                `;
                const removeBtn = li.querySelector('button');
                if (removeBtn) {
                    removeBtn.onclick = () => removePost(post);
                }
                postsList.appendChild(li);
            });
            saveUserData();
        }

        function addPost() {
            const name = newPostNameInput.value.trim().toUpperCase();
            if (name && !posts.includes(name)) {
                posts.push(name);
                newPostNameInput.value = '';
                renderPosts();
            }
        }

        function removePost(postToRemove) {
            showModal(`Tem certeza que deseja remover o posto ${postToRemove}?`, (confirmed) => {
                if (confirmed) {
                    posts = posts.filter(post => post !== postToRemove);
                    renderPosts();
                }
            });
        }

        addPostBtn.addEventListener('click', addPost);
        newPostNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPost();
        });
        
        isEventDayCheckbox.addEventListener('change', () => {
            if (isEventDayCheckbox.checked) {
                manualModeRadio.checked = true;
                autoModeRadio.disabled = true;
                const showIndex = posts.indexOf('SHOW');
                if (showIndex > -1) {
                    posts.splice(showIndex, 1);
                }
                ['BIPAGEM', 'PCD', 'GEODÉSICA'].forEach(p => {
                    if (!posts.includes(p)) {
                        posts.push(p);
                    }
                });
                eventConfigDiv.classList.remove('hidden');
            } else {
                 autoModeRadio.disabled = false;
                 const bipagemIndex = posts.indexOf('BIPAGEM');
                 if(bipagemIndex > -1) { posts.splice(bipagemIndex, 1); }
                 const pcdIndex = posts.indexOf('PCD');
                 if(pcdIndex > -1) { posts.splice(pcdIndex, 1); }
                 const geodesicIndex = posts.indexOf('GEODÉSICA');
                 if(geodesicIndex > -1) { posts.splice(geodesicIndex, 1); }
                eventConfigDiv.classList.add('hidden');
            }
            renderPosts();
            renderSchedule(currentSchedule, scheduleDateInput.value);
            renderLunchAssignmentFields();
        });

        scheduleDateInput.addEventListener('change', () => {
            const selectedDate = new Date(scheduleDateInput.value + 'T00:00:00');
            const dayOfWeek = selectedDate.getDay();
            if (dayOfWeek === 4) {
                thursdayShowConfigDiv.classList.remove('hidden');
                const showDeQuintaIndex = posts.indexOf('SHOW DE QUINTA');
                if(showDeQuintaIndex === -1) {
                    posts.push('SHOW DE QUINTA');
                    renderPosts();
                }
            } else {
                thursdayShowConfigDiv.classList.add('hidden');
                const showDeQuintaIndex = posts.indexOf('SHOW DE QUINTA');
                if(showDeQuintaIndex > -1) {
                    posts.splice(showDeQuintaIndex, 1);
                    renderPosts();
                }
            }
            renderLunchAssignmentFields();
        });
        
        function formatHour(hourNumber) {
            const hours = Math.floor(hourNumber);
            const minutes = (hourNumber - hours) * 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function getWorkHours(isEventDay, isOvertimeNeeded, date) {
            const dayOfWeek = date.getDay();
            let allWorkHours = [];
            let openingHours = [];

            if (dayOfWeek >= 2 && dayOfWeek <= 5) {
                openingHours = Array.from({ length: 9 }, (_, i) => 12.5 + i);
                if (isEventDay) {
                    const group2ScheduleType = group2ScheduleTypeSelect.value;
                    let normalHours = Array.from({ length: 9 }, (_, i) => 9 + i);
                    let group2Hours = [];
                    if (group2ScheduleType === '11h-20h') {
                        group2Hours = Array.from({ length: 10 }, (_, i) => 11 + i);
                    } else if (group2ScheduleType === '12h-21h') {
                        group2Hours = Array.from({ length: 10 }, (_, i) => 12 + i);
                    }
                    allWorkHours = [...new Set([...normalHours, ...group2Hours])].sort((a, b) => a - b);
                    if (isOvertimeNeeded) {
                       const extraHours = [18, 19, 20];
                       allWorkHours = [...new Set([...allWorkHours, ...extraHours])].sort((a,b) => a-b);
                    }
                } else {
                    const normalHours = Array.from({ length: 9 }, (_, i) => 13 + i);
                    allWorkHours = normalHours;
                }
            } else if (dayOfWeek === 6 || dayOfWeek === 0) {
                openingHours = Array.from({ length: 9 }, (_, i) => 8.5 + i);
                if (isEventDay) {
                    const group2ScheduleType = group2ScheduleTypeSelect.value;
                    let normalHours = Array.from({ length: 9 }, (_, i) => 9 + i);
                    let group2Hours = [];
                    if (group2ScheduleType === '11h-20h') {
                        group2Hours = Array.from({ length: 10 }, (_, i) => 11 + i);
                    } else if (group2ScheduleType === '12h-21h') {
                        group2Hours = Array.from({ length: 10 }, (_, i) => 12 + i);
                    }
                    allWorkHours = [...new Set([...normalHours, ...group2Hours])].sort((a, b) => a - b);
                    if (isOvertimeNeeded) {
                        const extraHours = [18, 19, 20];
                        allWorkHours = [...new Set([...allWorkHours, ...extraHours])].sort((a,b) => a-b);
                    }
                } else {
                    const normalHours = Array.from({ length: 9 }, (_, i) => 9 + i);
                    allWorkHours = normalHours;
                }
            } else {
                showModal("A escala é gerada apenas para Terça-feira a Domingo.", () => {}, false);
                return null;
            }
            
            return { allWorkHours, openingHours };
        }

        function generateSchedule() {
            const selectedDate = scheduleDateInput.value;
            if (!selectedDate || members.length === 0 || posts.filter(p => p !== 'ALMOÇO').length < 3) {
                showModal("Por favor, selecione uma data e adicione membros e postos (incluindo P1 e VESTIÁRIO).", () => {}, false);
                return;
            }
            const isEventDay = isEventDayCheckbox.checked;
            const isOvertimeNeeded = isOvertimeNeededCheckbox.checked;
            const isAutomatic = autoModeRadio.checked;
            isWeeklyMode = weeklyModeRadio.checked;

            if (isWeeklyMode) {
                currentSchedule = generateWeeklySchedule(selectedDate, isEventDay, isOvertimeNeeded, isAutomatic);
                renderSchedule(currentSchedule);
                selectiveExportDiv.classList.remove('hidden');
                renderExportButtons();
            } else {
                const date = new Date(selectedDate + 'T00:00:00');
                const workHoursData = getWorkHours(isEventDay, isOvertimeNeeded, date);
                if (!workHoursData) return;
                const { allWorkHours } = workHoursData;

                if (isAutomatic) {
                     currentSchedule = [{ date: selectedDate, schedule: generateAutomaticDailySchedule(allWorkHours, members, posts, date)}];
                } else {
                    currentSchedule = [{ date: selectedDate, schedule: generateManualDailyDailySchedule(allWorkHours, members, posts, isEventDay)}];
                }
                renderSchedule(currentSchedule);
                selectiveExportDiv.classList.add('hidden');
            }

            saveCloudBtn.classList.remove('hidden');
            exportScheduleBtn.classList.remove('hidden');
            exportExcelBtn.classList.remove('hidden');
        }

        function generateManualDailyDailySchedule(allWorkHours, members, posts, isEventDay) {
            return allWorkHours.map(hour => ({
                hour: formatHour(hour),
                assignments: {}
            }));
        }

        function generateWeeklySchedule(startDate, isEventDay, isOvertimeNeeded, isAutomatic) {
            const weeklySchedule = [];
            let date = new Date(startDate + 'T00:00:00');
            for (let i = 0; i < 7; i++) {
                const dayOfWeek = date.getDay();
                const workHoursData = getWorkHours(isEventDay, isOvertimeNeeded, date);
                if (workHoursData) {
                    const { allWorkHours } = workHoursData;
                    let dailySchedule = [];
                    if (isAutomatic) {
                        dailySchedule = generateAutomaticDailySchedule(allWorkHours, members, posts, date);
                    } else {
                        dailySchedule = generateManualDailyDailySchedule(allWorkHours, members, posts, isEventDay);
                    }
                    weeklySchedule.push({
                        date: date.toISOString().split('T')[0],
                        schedule: dailySchedule
                    });
                }
                date.setDate(date.getDate() + 1);
            }
            return weeklySchedule;
        }

        function generateAutomaticDailySchedule(allWorkHours, members, posts, date) {
            const schedule = [];
            const dayOfWeek = date.getDay();
            const isThursday = dayOfWeek === 4;
            const showMember = showMemberSelect.value;
            
            const lastPost = {};
            const lunchAssignments = {};
            const allPosts = posts.filter(p => p !== 'ALMOÇO');
            
            // Atribuição manual de almoço
            let manualLunchAssignments = {};
            members.forEach(member => {
                const selectElement = document.getElementById(`lunch-${member.replace(/\s/g, '-')}`);
                if (selectElement && selectElement.value) {
                    manualLunchAssignments[member] = parseFloat(selectElement.value);
                }
            });

            let lunchSlots = {};
            const maxPerLunch = members.length > 4 ? 2 : 1;

            let allLunchHours = getLunchHoursForDate(date);
            
            members.forEach(member => {
                const assignedHour = manualLunchAssignments[member] || null;
                if (assignedHour) {
                    if (!lunchSlots[assignedHour]) lunchSlots[assignedHour] = 0;
                    if (lunchSlots[assignedHour] < maxPerLunch) {
                        lunchAssignments[member] = assignedHour;
                        lunchSlots[assignedHour]++;
                    }
                }
            });

            let unassignedMembers = members.filter(m => !lunchAssignments[m]);
            unassignedMembers.sort(() => 0.5 - Math.random());
            let currentLunchHourIndex = 0;
            
            // Atribuição automática de almoço para quem não foi definido manualmente
            unassignedMembers.forEach(member => {
                let assigned = false;
                for (let i = 0; i < allLunchHours.length; i++) {
                    const hour = allLunchHours[currentLunchHourIndex % allLunchHours.length];
                    if (!lunchSlots[hour]) lunchSlots[hour] = 0;
                    if (lunchSlots[hour] < maxPerLunch) {
                        lunchAssignments[member] = hour;
                        lunchSlots[hour]++;
                        assigned = true;
                        break;
                    }
                    currentLunchHourIndex++;
                }
            });
            
            // Lógica principal de atribuição de postos
            allWorkHours.forEach(hour => {
                const assignments = {};
                let membersToAssign = [...members];
                
                // Atribuição do Show de Quinta
                if (isThursday && hour >= 20 && hour <= 21 && showMember) {
                    assignments[showMember] = 'SHOW DE QUINTA';
                    membersToAssign = membersToAssign.filter(m => m !== showMember);
                    lastPost[showMember] = 'SHOW DE QUINTA';
                }
                
                // Atribuição do Almoço
                membersToAssign = membersToAssign.filter(member => {
                    if (lunchAssignments[member] === hour) {
                         assignments[member] = 'ALMOÇO';
                         lastPost[member] = 'ALMOÇO';
                         return false;
                    }
                    return true;
                });
                
                let remainingMembers = membersToAssign;
                let usedPostsThisHour = Object.values(assignments);
                const priorityPosts = ['P1', 'VESTIÁRIO', 'CATRACA', 'CIRCULAÇÃO'];
                
                // Atribuição da Abertura (prioridade máxima)
                const openingMember = openingMemberSelect.value;
                const workHoursData = getWorkHours(isEventDayCheckbox.checked, false, date);
                if (openingMember && remainingMembers.includes(openingMember) && workHoursData.openingHours.includes(hour)) {
                    if (!usedPostsThisHour.includes('P1')) {
                        assignments[openingMember] = 'P1';
                        remainingMembers = remainingMembers.filter(m => m !== openingMember);
                        lastPost[openingMember] = 'P1';
                        usedPostsThisHour.push('P1');
                    }
                }

                // Atribuição de postos prioritários
                const availablePriorityPosts = priorityPosts.filter(p => !usedPostsThisHour.includes(p));
                const shuffledRemainingMembers = [...remainingMembers].sort(() => 0.5 - Math.random());
                
                availablePriorityPosts.forEach(post => {
                    if (shuffledRemainingMembers.length === 0) return;
                    const memberToAssign = shuffledRemainingMembers.shift();
                    assignments[memberToAssign] = post;
                    lastPost[memberToAssign] = post;
                    usedPostsThisHour.push(post);
                });
                
                // Atribuição de outros postos
                let nonPriorityPosts = allPosts.filter(p => !usedPostsThisHour.includes(p));
                let shuffledNonPriorityPosts = [...nonPriorityPosts].sort(() => 0.5 - Math.random());

                shuffledRemainingMembers.forEach(member => {
                     // Lógica de revezamento aprimorada
                    let postToAssign = null;
                    const postHistoryForMember = postHistory[member] || {};
                    const postsByUsage = [...shuffledNonPriorityPosts].sort((a, b) => (postHistoryForMember[a] || 0) - (postHistoryForMember[b] || 0));

                    for (const post of postsByUsage) {
                         if (post !== lastPost[member]) {
                            postToAssign = post;
                            break;
                        }
                    }
                    
                    if (postToAssign) {
                        assignments[member] = postToAssign;
                        lastPost[member] = postToAssign;
                        shuffledNonPriorityPosts = shuffledNonPriorityPosts.filter(p => p !== postToAssign);
                        if(shuffledNonPriorityPosts.length === 0) {
                            shuffledNonPriorityPosts = [...nonPriorityPosts].sort(() => 0.5 - Math.random());
                        }
                    } else {
                        // Se não encontrar um posto para revezar, atribui o menos usado
                        const fallbackPost = postsByUsage[0];
                        assignments[member] = fallbackPost;
                        lastPost[member] = fallbackPost;
                    }
                });
                
                schedule.push({ hour: formatHour(hour), assignments: assignments });
            });
            
            return schedule;
        }

        function syncScheduleFromDOM() {
            const tables = scheduleTableContainer.querySelectorAll('table');
            if (tables.length === 0) return;

            currentSchedule.forEach((dayEntry, dayIndex) => {
                const table = tables[dayIndex];
                const rows = table.querySelector('tbody').rows;
                dayEntry.schedule.forEach((entry, rowIndex) => {
                    const row = rows[rowIndex];
                    members.forEach((member, memberIndex) => {
                        const cell = row.cells[memberIndex + 1];
                        const select = cell.querySelector('select');
                        if (select) {
                            entry.assignments[member] = select.value;
                        } else {
                            entry.assignments[member] = cell.textContent.split(' ')[0] || '';
                        }
                    });
                });
            });
        }

        function renderSchedule(scheduleData) {
            scheduleTableContainer.innerHTML = '';
            if (scheduleData.length === 0) {
                scheduleTableContainer.innerHTML = '<p class="text-center text-gray-500">Nenhuma escala para esta data.</p>';
                return;
            }

            scheduleData.forEach(dayEntry => {
                const date = new Date(dayEntry.date + 'T00:00:00');
                const isEventDay = isEventDayCheckbox.checked;
                const isOvertimeNeeded = isOvertimeNeededCheckbox.checked;
                const dayOfWeek = date.getDay();
                const openingMember = openingMemberSelect.value;
                const { openingHours } = getWorkHours(isEventDay, isOvertimeNeeded, date);

                const dayHeader = document.createElement('h3');
                dayHeader.className = 'text-2xl font-bold mt-10 text-gray-200';
                dayHeader.textContent = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                scheduleTableContainer.appendChild(dayHeader);

                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-700 mt-4 bg-gray-800 rounded-lg shadow';
                
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                const timeHeader = document.createElement('th');
                timeHeader.textContent = 'Horário';
                headerRow.appendChild(timeHeader);
                members.forEach(member => {
                    const th = document.createElement('th');
                    th.textContent = member;
                    headerRow.appendChild(th);
                });

                const tbody = table.createTBody();
                
                const group1Members = isEventDay ? Array.from(group1Select.selectedOptions).map(opt => opt.value) : [];
                const group2Members = isEventDay ? Array.from(group2Select.selectedOptions).map(opt => opt.value) : [];
                const group2ScheduleType = group2ScheduleTypeSelect.value;
                const group2StartHour = group2ScheduleType === '11h-20h' ? 11 : 12;
                const group2EndHour = group2ScheduleType === '11h-20h' ? 20 : 21;
                const isWeekend = (dayOfWeek === 6 || dayOfWeek === 0);

                dayEntry.schedule.forEach(entry => {
                    const row = tbody.insertRow();
                    const timeCell = row.insertCell();
                    timeCell.textContent = entry.hour;
                    
                    members.forEach(member => {
                        const cell = row.insertCell();
                        const select = document.createElement('select');
                        select.className = 'w-full rounded-md bg-gray-700 text-gray-200';
                        const blankOption = document.createElement('option');
                        blankOption.value = '';
                        blankOption.textContent = '';
                        select.appendChild(blankOption);
                        const allPosts = posts;
                        allPosts.forEach(post => {
                            const option = document.createElement('option');
                            option.value = post;
                            option.textContent = post;
                            if (entry.assignments[member] === post) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                        cell.appendChild(select);

                        const assignedPost = entry.assignments[member];
                        const hour = parseFloat(entry.hour.replace(':', '.'));

                        if (assignedPost === 'ALMOÇO') {
                            cell.classList.add('lunch-cell');
                        }

                        const isOpeningHour = openingHours.includes(hour);
                        if (member === openingMember && isOpeningHour) {
                            cell.classList.add('opening-cell');
                        }

                        if (isEventDay && isOvertimeNeeded && group1Members.includes(member) && hour >= 18 && hour <= 20) {
                            select.style.backgroundColor = '#d97706';
                            select.title = 'Hora Extra';
                        }
                        if (isEventDay) {
                            if (group2Members.includes(member) && (hour < group2StartHour || hour > group2EndHour)) {
                                cell.style.backgroundColor = '#1f2937';
                                cell.querySelector('select').disabled = true;
                            } else if (group1Members.includes(member) && (hour < 9 || (hour > 17 && !(isOvertimeNeeded && hour >= 18 && hour <= 20)))) {
                                cell.style.backgroundColor = '#1f2937';
                                cell.querySelector('select').disabled = true;
                            }
                        } else {
                            if (!isWeekend && (hour < 13 || hour > 21)) {
                                cell.style.backgroundColor = '#1f2937';
                                cell.querySelector('select').disabled = true;
                            } else if (isWeekend && (hour < 9 || hour > 17)) {
                                cell.style.backgroundColor = '#1f2937';
                                cell.querySelector('select').disabled = true;
                            }
                        }
                    });
                });
                scheduleTableContainer.appendChild(table);
            });
        }

         function exportToExcel() {
            if (currentSchedule.length === 0) {
                showModal("Nenhuma escala para exportar. Por favor, gere uma primeiro.", () => {}, false);
                return;
            }
            syncScheduleFromDOM();
            
            const workbook = XLSX.utils.book_new();

            currentSchedule.forEach(dayEntry => {
                const date = new Date(dayEntry.date + 'T00:00:00');
                const sheetName = date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'short' });

                const data = [
                    ['Horário', ...members.map(member => member)]
                ];

                dayEntry.schedule.forEach(entry => {
                    const row = [entry.hour];
                    members.forEach(member => {
                        let post = entry.assignments[member] || '';
                        row.push(post);
                    });
                    data.push(row);
                });

                const worksheet = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
            });

            XLSX.writeFile(workbook, 'escala.xlsx');
        }

        function renderExportLayout(dayEntry) {
             exportLayoutDiv.innerHTML = '';
             const date = new Date(dayEntry.date + 'T00:00:00');
             const dayOfWeek = date.getDay();
             const eventName = eventNameInput.value;
             const eventTime = eventTimeSelect.value;
             const showName = showNameInput.value;
             const showMember = showMemberSelect.value;

             const dayHeader = document.createElement('h3');
             dayHeader.className = 'text-2xl font-bold mt-8';
             let headerText = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
             
             if(isEventDayCheckbox.checked) {
                 headerText = `${eventName} - ${headerText} - ${eventTime}h`;
             }
             if (dayOfWeek === 4 && showName && showMember) {
                 headerText += ` - Show: ${showName} (Responsável: ${showMember})`;
             }

             dayHeader.textContent = headerText;
             exportLayoutDiv.appendChild(dayHeader);

             const table = document.createElement('table');
             table.className = 'mt-2';
             
             const thead = table.createTHead();
             const headerRow = thead.insertRow();
             headerRow.innerHTML = `<th>Horário</th>${members.map(member => {
                 let memberName = member;
                 if (member === openingMemberSelect.value) {
                     memberName += ` - Abertura`;
                 }
                 return `<th style="text-align:center;">${memberName}</th>`;
             }).join('')}`;
             
             const tbody = table.createTBody();
             const isEventDay = isEventDayCheckbox.checked;
             const isOvertimeNeeded = isOvertimeNeededCheckbox.checked;
             const group1Members = isEventDay ? Array.from(group1Select.selectedOptions).map(option => option.value) : [];
             const group2Members = isEventDay ? Array.from(group2Select.selectedOptions).map(option => option.value) : [];
             const group2ScheduleType = group2ScheduleTypeSelect.value;
             const group2StartHour = group2ScheduleType === '11h-20h' ? 11 : 12;
             const group2EndHour = group2ScheduleType === '11h-20h' ? 20 : 21;

             dayEntry.schedule.forEach(entry => {
                 const row = tbody.insertRow();
                 row.innerHTML = `<td>${entry.hour}</td>${members.map(member => {
                     let post = entry.assignments[member] || '';
                     let style = '';
                     const hour = parseFloat(entry.hour.replace(':', '.'));

                     if (isEventDay) {
                         if (group2Members.includes(member) && (hour < group2StartHour || hour > group2EndHour)) {
                             post = '';
                         }
                         if (group1Members.includes(member) && hour > 20) {
                             post = '';
                         }
                     }
                     if (post === 'ALMOÇO') {
                         style = 'background-color: #4a192c; color: #fca5a5;';
                     }
                     if (isEventDay && isOvertimeNeeded && group1Members.includes(member) && hour >= 18 && hour <= 20) {
                         post = `${post} (EXTRA)`;
                         style = 'background-color: #d97706;';
                     }
                     if (isEventDay && group1Members.includes(member) && (hour > 17 && !isOvertimeNeeded)) {
                         post = '';
                     }
                     if (member === openingMemberSelect.value && getWorkHours(isEventDay, isOvertimeNeeded, date).openingHours.includes(hour)) {
                         style = 'background-color: #1f3d2f; font-weight: 600; color: #99f6e4;';
                     }
                     return `<td style="text-align:center; ${style}">${post}</td>`;
                 }).join('')}`;
             });
             exportLayoutDiv.appendChild(table);
             return html2canvas(exportLayoutDiv, { scale: 2, logging: false }).then(canvas => {
                const link = document.createElement('a');
                link.download = `escala_${dayEntry.date}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
         }

        async function exportScheduleAsJpg() {
            if (currentSchedule.length === 0) {
                showModal("Nenhuma escala para exportar. Por favor, gere uma primeiro.", () => {}, false);
                return;
            }
            syncScheduleFromDOM();
            if (isWeeklyMode) {
                for (let i = 0; i < currentSchedule.length; i++) {
                    await renderExportLayout(currentSchedule[i]);
                }
            } else {
                await renderExportLayout(currentSchedule[0]);
            }
        }

        function renderExportButtons() {
            exportDayButtonsDiv.innerHTML = '';
            const daysOfWeek = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];

            currentSchedule.forEach((dayEntry, index) => {
                const date = new Date(dayEntry.date + 'T00:00:00');
                const dayName = daysOfWeek[date.getDay()];

                const button = document.createElement('button');
                button.className = 'btn-secondary text-sm p-2 px-3 rounded-xl';
                button.textContent = `Exportar ${dayName}`;
                button.addEventListener('click', () => exportSpecificDay(index));
                exportDayButtonsDiv.appendChild(button);
            });
        }
        
        async function exportSpecificDay(dayIndex) {
            syncScheduleFromDOM();
            if (currentSchedule[dayIndex]) {
                await renderExportLayout(currentSchedule[dayIndex]);
            } else {
                showModal("Dia inválido para exportação.", () => {}, false);
            }
        }

        function exportAnalysis() {
            // Usa html2canvas para capturar a div que contém o gráfico e o texto
            html2canvas(chartContainer, { scale: 2, logging: false }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'analise_de_postos.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
        
        generateScheduleBtn.addEventListener('click', generateSchedule);
        saveCloudBtn.addEventListener('click', () => saveScheduleToCloud(creatorName));
        exportScheduleBtn.addEventListener('click', exportScheduleAsJpg);
        exportExcelBtn.addEventListener('click', exportToExcel);
        exportAnalysisBtn.addEventListener('click', exportAnalysis);
        
        dailyModeRadio.addEventListener('change', () => {
             isWeeklyMode = false;
             renderSchedule(currentSchedule);
             selectiveExportDiv.classList.add('hidden');
        });
        weeklyModeRadio.addEventListener('change', () => {
             isWeeklyMode = true;
             renderSchedule(currentSchedule);
             selectiveExportDiv.classList.remove('hidden');
             renderExportButtons();
        });
        
        renderMembers();
        renderPosts();
    </script>
</body>
</html>
